# 初始化 0 号进程


# 附录

GCC提供一些标准 C 不支持的额外语法与功能，本节附录主要介绍代码中使用到的三个 GNU C 的拓展。

## Locally Declared Labels 扩展

**局部声明的标签**是作用域仅在*当前块及嵌套的块、嵌套的函数*内的标签，声明方式为`__label__ label1, label2, /* … */;`。局部标签的声明必须在代码块的开头所有其他普通声明与语句之前。局部标签的声明只声明其名称，具体的定义依然需要靠`label:`来实现。

在较为复杂的宏中局部标签使用 `goto` 跳出循环或获取某一地址，用局部标签会更方便，可以避免多次引用这一宏引发的标签重复定义的问题。

使用示例见 `sched.h` 中 `init_task0` 宏的定义，其中使用 `__label__ ret;` 声明了局部标签`ret`，并在 `write_csr(sepc, &&ret - 4 - (SBI_END + LINEAR_OFFSET - START_CODE));` 中使用了它的地址，而 `ret` 的具体定义在 `ret: ;` 处。

## Labels as Values 扩展

对于当前函数中定义的标签，可以使用 `&&` 运算符获取其地址，获取到的值的类型为 `void *`，例如：

```c
void *ptr;
/* … */
ptr = &&foo;
```

同时你可以用 `goto *ptr;` 来跳转至该标签所代表的地址。

注意：跨函数使用这一方法跳转会导致不可预知的后果。

在 `inline` 函数或 `clone` 函数中，对同一个标签获取到的值可能不同，如果需要保证它们相同，需要使用 `__attribute__((__noinline__,__noclone__))` 以避免函数被作为 `inline` 函数或 `clone` 函数。如果在静态变量初始值设定中使用 `&&foo`，则禁止 `inline` 或 `clone`。

## Statements and Declarations in Expressions 扩展

用括号括起来的复合语句可能在 GNU C 中被当做表达式。因此可以在表达式中使用循环、switch和局部变量。

复合语句是指由大括号包围的一系列语句，因此在上述结构中，圆括号可以包含大括号，例如：

```c
({ int y = foo();
   int z;
   if (y > 0) z = y;
   else z = - y;
   z; })
```

其中复合语句的最后一句应该是一个表达式，其返回值作为整个结构的值，否则返回类型为 `void`，并且没有返回值。

这一特性使其在确保宏定义的“安全”中较为有用，可用于确保操作数只运算一次。例如在`#define max(a,b) ((a) > (b) ? (a) : (b))`的定义中，a 和 b 会被计算两次，如果调用它的运算符有副作用（如++运算符），可能会导致错误的结果，在 GNU C 中，如果知道操作数的类型（这里取`int`），可以通过如下定义宏来避免此问题：

```c
#define maxint(a,b) \
  ({int _a = (a), _b = (b); _a > _b ? _a : _b; })
```

比如在如下示例中，`max` 宏会导致a、b自增两次，而 `maxint` 宏则不会：

```c
int a = 0;
int b = 1;
int c = max(a++, b++);
// int c = ((a++) > (b++) ? (a++) : (b++));
int d = maxint(a++, b++);
// int d = ({
//          int _a = (a++), _b = (b++);
//          _a > _b ? _a : _b;
//          });
```

---

请注意，引入变量声明（例如在 `maxint` 中）可能会和“主调”函数中原有的变量相互影响产生错误，例如在以下示例中

```c
int _a = 1, _b = 2;
int c = max(_a, _b);
// int c = ((_a) > (_b) ? (_a) : (_b));
int d = maxint(_a, _b);
// int d = ({int _a = (_a), _b = (_b); _a > _b ? _a : _b; });
// 展开后变量定义会导致错误
```

当我们像下例中递归地使用此模式时，也可能会发生此问题：

```c
#define maxint3(a, b, c) \
  ({int _a = (a), _b = (b), _c = (c); maxint (maxint (_a, _b), _c); })
```

---

常量表达式（如枚举常量的值、位域的宽度或静态变量的初始值）中不允许嵌入语句。

如果不知道操作数的类型，就需要使用 `typeof` 或 `__auto_type`。
